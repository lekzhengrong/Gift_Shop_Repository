<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Gift Products</title>
    <style>
        .product-options { display: flex; gap: 20px; flex-wrap: wrap; }
        .product-option { text-align: center; width: 150px; }
        .product-option img { width: 150px; height: auto; }
    </style>
</head>
<body>
    <h2>Step 2: Choose Products</h2>
    <form id="gift-selection-form">
        <!-- Hidden input for the selected gift box -->
        <input type="hidden" name="id" id="box-id" value="">

        <div class="product-options">
            {% for product in collections['gift-products'].products %}
                <div class="product-option">
                    <input type="checkbox" id="product-{{ product.variants.first.id }}" name="items[]" value="{{ product.variants.first.id }}">
                    <label for="product-{{ product.variants.first.id }}">
                        <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title }}">
                        <p>{{ product.title }}</p>
                    </label>
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-to-cart" class="add-to-cart-button">Add to Cart</button>
    </form>

    <script>
        /**
         * Function to extract query parameters from the URL
         */
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        /**
         * Initialize Step 2: Validate the box_id and set it to the hidden input
         */
        function initializeStep2() {
            // Extract the box_id from the query parameters
            const boxId = getQueryParam('box_id');
            console.log("Extracted box_id:", boxId); // Debugging

            // Validate and set the box_id to the hidden input
            if (boxId) {
                const hiddenInput = document.getElementById('box-id');
                hiddenInput.value = boxId;
                console.log("Box ID set successfully in hidden input:", hiddenInput.value); // Debugging
            } else {
                alert("No gift box selected. Please return to the previous page.");
                window.location.href = '/pages/gift-boxes'; // Replace with your Step 1 URL
            }
        }

        /**
         * Add-to-cart functionality
         */
        async function addToCart() {
            // Validate the box ID from the hidden input
            const boxId = document.getElementById('box-id').value;
            if (!boxId) {
                alert("No gift box selected. Please return to the previous page.");
                return;
            }

            // Collect selected products
            const selectedProducts = document.querySelectorAll('input[name="items[]"]:checked');
            if (selectedProducts.length === 0) {
                alert("Please select at least one product to add to the box.");
                return;
            }

            // Prepare the items array for Shopify API
            const items = [
                { id: boxId, quantity: 1 }, // Add the selected gift box
                ...Array.from(selectedProducts).map(product => ({
                    id: product.value,
                    quantity: 1,
                }))
            ];

            console.log("Items to be added to cart:", items); // Debugging

            // Send the POST request to Shopify's cart API
            try {
                const response = await fetch('/cart/add.js', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items }), // Use Shopify API's expected format
                });

                if (response.ok) {
                    window.location.href = '/cart'; // Redirect to cart page on success
                } else {
                    const error = await response.json();
                    console.error("Error response from Shopify:", error);
                    alert("Something went wrong while adding items to the cart.");
                }
            } catch (error) {
                console.error("Network error:", error);
                alert("An error occurred. Please try again.");
            }
        }

        // Initialize the step when the page loads
        window.addEventListener('DOMContentLoaded', initializeStep2);

        // Attach the add-to-cart functionality to the button
        document.getElementById('add-to-cart').addEventListener('click', addToCart);
    </script>
</body>
</html>
